#!/bin/bash

set -e

build_flavor="$1"

ARCH=amd64

case "$build_flavor" in
upstream)
    P="qemu-8.1.2"
    PV="8.1.2"
    RUYI_DATESTAMP=20231121
    srcfile="${P}.tar.xz"
    SRC_URI="https://download.qemu.org/$srcfile"
    pkgversion="RuyiSDK $RUYI_DATESTAMP"
    ;;
xthead)
    P="qemu-6.1.0"
    PV="6.1.0"
    RUYI_DATESTAMP=20231207
    thead_commit_hash=03813c9fe8
    srcfile="qemu-xthead-$PV-g$thead_commit_hash.tar.zst"
    SRC_URI="https://mirror.iscas.ac.cn/ruyisdk/dist/$srcfile"
    pkgversion="T-Head commit $thead_commit_hash, RuyiSDK $RUYI_DATESTAMP"
    ;;
*)
    echo "usage: ruyi-build-qemu <upstream|xthead>" >&2
    exit 1
    ;;
esac

USER_TARGETS="riscv32-linux-user,riscv64-linux-user"

USER_TARGET_EXES=(
    qemu-riscv32
    qemu-riscv64
)

SYSTEM_TARGETS="riscv32-softmmu,riscv64-softmmu"

SYSTEM_TARGET_EXES=(
    qemu-system-riscv32
    qemu-system-riscv64
)

INSTALL_ROOT=/tmp/prefix
INSTALL_ROOT_USER="$INSTALL_ROOT/qemu-user-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP"
INSTALL_ROOT_SYSTEM="$INSTALL_ROOT/qemu-system-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP"

COMMON_CONFIG_ARGS=(
    --disable-docs
    --with-pkgversion="$pkgversion"
)

# static-pie breaks the xthead qemu, because apparently too much TLS is used
# likely due to VLEN=1024 pushing the CPU state size too high
STATIC_BUILD_CONFIG_ARGS=( --static )
if [[ $build_flavor == xthead ]]; then
    STATIC_BUILD_CONFIG_ARGS+=( --disable-pie )
fi

pushd /tmp
    wget "$SRC_URI"
    tar xf "$srcfile"
popd

SRC_DIR="/tmp/${srcfile%.tar.*}"

mkdir /tmp/build-user
pushd /tmp/build-user
    "$SRC_DIR"/configure "${COMMON_CONFIG_ARGS[@]}" \
        "${STATIC_BUILD_CONFIG_ARGS[@]}" \
        --prefix="$INSTALL_ROOT_USER" \
        --target-list="$USER_TARGETS"
    ninja install

    # firmware is unneeded in the static-user build
    rm -rf "$INSTALL_ROOT_USER/share"
popd

mkdir /tmp/build-sys
pushd /tmp/build-sys
    "$SRC_DIR"/configure "${COMMON_CONFIG_ARGS[@]}" \
        --prefix="$INSTALL_ROOT_SYSTEM" \
        --target-list="$SYSTEM_TARGETS"
    ninja install
popd

pushd "$INSTALL_ROOT"
    tar --zstd -cvf "/out/qemu-user-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP.$ARCH.tar.zst" \
        "qemu-user-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP"
    tar --zstd -cvf "/out/qemu-system-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP.$ARCH.tar.zst" \
        "qemu-system-riscv-$build_flavor-$PV.ruyi-$RUYI_DATESTAMP"
popd
